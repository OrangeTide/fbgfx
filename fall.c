#include <stddef.h>
#include <string.h>
#include <stdint.h>
#include <stdlib.h>
#include <time.h>
#include "gfx.h"

/******************************************************************************/

static const unsigned font_w = 8, font_h = 8;
static const unsigned char font_base = 0x20, font_glyphs = 96;
static const unsigned char font[96 * 8] = {
	/* ' '  */ 0, 0, 0, 0, 0, 0, 0, 0, 
	/* '!'  */ 24, 24, 24, 24, 0, 24, 24, 0, 
	/* '"'  */ 108, 108, 72, 0, 0, 0, 0, 0, 
	/* '#'  */ 108, 108, 254, 108, 254, 108, 108, 0, 
	/* '$'  */ 16, 124, 208, 124, 22, 124, 16, 0, 
	/* '%'  */ 98, 102, 12, 24, 48, 102, 70, 0, 
	/* '&'  */ 56, 108, 104, 118, 220, 204, 118, 0, 
	/* '''  */ 24, 24, 48, 0, 0, 0, 0, 0, 
	/* '('  */ 12, 24, 48, 48, 48, 24, 12, 0, 
	/* ')'  */ 48, 24, 12, 12, 12, 24, 48, 0, 
	/* '*'  */ 0, 108, 56, 254, 56, 108, 0, 0, 
	/* '+'  */ 0, 24, 24, 126, 24, 24, 0, 0, 
	/* ','  */ 0, 0, 0, 0, 0, 24, 24, 16, 
	/* '-'  */ 0, 0, 0, 126, 0, 0, 0, 0, 
	/* '.'  */ 0, 0, 0, 0, 0, 24, 24, 0, 
	/* '/'  */ 2, 6, 12, 24, 48, 96, 64, 0, 
	/* '0'  */ 60, 102, 110, 118, 102, 102, 60, 0, 
	/* '1'  */ 24, 24, 56, 24, 24, 24, 60, 0, 
	/* '2'  */ 124, 6, 6, 60, 96, 96, 126, 0, 
	/* '3'  */ 124, 6, 6, 28, 6, 6, 124, 0, 
	/* '4'  */ 102, 102, 102, 126, 6, 6, 6, 0, 
	/* '5'  */ 126, 96, 96, 124, 6, 6, 124, 0, 
	/* '6'  */ 62, 96, 96, 124, 102, 102, 60, 0, 
	/* '7'  */ 126, 6, 12, 24, 24, 24, 24, 0, 
	/* '8'  */ 60, 102, 102, 60, 102, 102, 60, 0, 
	/* '9'  */ 60, 102, 102, 62, 6, 6, 124, 0, 
	/* ':'  */ 0, 24, 24, 0, 24, 24, 0, 0, 
	/* ';'  */ 0, 0, 24, 24, 0, 24, 24, 16, 
	/* '<'  */ 12, 24, 48, 96, 48, 24, 12, 0, 
	/* '='  */ 0, 0, 126, 0, 126, 0, 0, 0, 
	/* '>'  */ 48, 24, 12, 6, 12, 24, 48, 0, 
	/* '?'  */ 60, 102, 6, 28, 24, 0, 24, 0, 
	/* '@'  */ 60, 102, 110, 110, 110, 96, 62, 0, 
	/* 'A'  */ 60, 102, 102, 126, 102, 102, 102, 0, 
	/* 'B'  */ 124, 102, 102, 124, 102, 102, 124, 0, 
	/* 'C'  */ 60, 102, 96, 96, 96, 102, 60, 0, 
	/* 'D'  */ 124, 102, 102, 102, 102, 102, 124, 0, 
	/* 'E'  */ 126, 96, 96, 120, 96, 96, 126, 0, 
	/* 'F'  */ 126, 96, 96, 120, 96, 96, 96, 0, 
	/* 'G'  */ 60, 102, 96, 110, 102, 102, 60, 0, 
	/* 'H'  */ 102, 102, 102, 126, 102, 102, 102, 0, 
	/* 'I'  */ 126, 24, 24, 24, 24, 24, 126, 0, 
	/* 'J'  */ 14, 6, 6, 6, 6, 102, 60, 0, 
	/* 'K'  */ 102, 108, 120, 112, 120, 108, 102, 0, 
	/* 'L'  */ 96, 96, 96, 96, 96, 96, 126, 0, 
	/* 'M'  */ 198, 238, 254, 214, 198, 198, 198, 0, 
	/* 'N'  */ 102, 118, 126, 110, 102, 102, 102, 0, 
	/* 'O'  */ 60, 102, 102, 102, 102, 102, 60, 0, 
	/* 'P'  */ 124, 102, 102, 124, 96, 96, 96, 0, 
	/* 'Q'  */ 60, 102, 102, 102, 110, 110, 62, 0, 
	/* 'R'  */ 124, 102, 102, 124, 102, 102, 102, 0, 
	/* 'S'  */ 62, 96, 96, 60, 6, 6, 124, 0, 
	/* 'T'  */ 126, 24, 24, 24, 24, 24, 24, 0, 
	/* 'U'  */ 102, 102, 102, 102, 102, 102, 60, 0, 
	/* 'V'  */ 102, 102, 102, 102, 60, 60, 24, 0, 
	/* 'W'  */ 198, 198, 198, 214, 254, 238, 198, 0, 
	/* 'X'  */ 102, 102, 60, 24, 60, 102, 102, 0, 
	/* 'Y'  */ 102, 102, 102, 60, 24, 24, 24, 0, 
	/* 'Z'  */ 126, 6, 12, 24, 48, 96, 126, 0, 
	/* '['  */ 60, 48, 48, 48, 48, 48, 60, 0, 
	/* '\'  */ 64, 96, 48, 24, 12, 6, 2, 0, 
	/* ']'  */ 60, 12, 12, 12, 12, 12, 60, 0, 
	/* '^'  */ 16, 56, 108, 0, 0, 0, 0, 0, 
	/* '_'  */ 0, 0, 0, 0, 0, 0, 0, 255, 
	/* '`'  */ 24, 24, 8, 0, 0, 0, 0, 0, 
	/* 'a'  */ 0, 0, 60, 6, 62, 102, 62, 0, 
	/* 'b'  */ 96, 96, 124, 102, 102, 102, 124, 0, 
	/* 'c'  */ 0, 0, 60, 102, 96, 102, 60, 0, 
	/* 'd'  */ 6, 6, 62, 102, 102, 102, 62, 0, 
	/* 'e'  */ 0, 0, 60, 102, 124, 96, 62, 0, 
	/* 'f'  */ 14, 24, 24, 60, 24, 24, 60, 0, 
	/* 'g'  */ 0, 0, 62, 102, 102, 62, 6, 124, 
	/* 'h'  */ 96, 96, 124, 102, 102, 102, 102, 0, 
	/* 'i'  */ 24, 0, 24, 24, 24, 24, 24, 0, 
	/* 'j'  */ 24, 0, 24, 24, 24, 24, 24, 112, 
	/* 'k'  */ 96, 96, 102, 108, 120, 108, 102, 0, 
	/* 'l'  */ 48, 48, 48, 48, 48, 48, 28, 0, 
	/* 'm'  */ 0, 0, 204, 254, 214, 198, 198, 0, 
	/* 'n'  */ 0, 0, 124, 102, 102, 102, 102, 0, 
	/* 'o'  */ 0, 0, 60, 102, 102, 102, 60, 0, 
	/* 'p'  */ 0, 0, 124, 102, 102, 124, 96, 96, 
	/* 'q'  */ 0, 0, 62, 102, 102, 62, 6, 6, 
	/* 'r'  */ 0, 0, 54, 56, 48, 48, 48, 0, 
	/* 's'  */ 0, 0, 62, 96, 60, 6, 124, 0, 
	/* 't'  */ 24, 24, 24, 60, 24, 24, 12, 0, 
	/* 'u'  */ 0, 0, 102, 102, 102, 102, 60, 0, 
	/* 'v'  */ 0, 0, 102, 102, 60, 60, 24, 0, 
	/* 'w'  */ 0, 0, 198, 198, 214, 254, 236, 0, 
	/* 'x'  */ 0, 0, 102, 60, 24, 60, 102, 0, 
	/* 'y'  */ 0, 0, 102, 102, 102, 62, 6, 124, 
	/* 'z'  */ 0, 0, 126, 12, 24, 48, 126, 0, 
	/* '{'  */ 28, 48, 48, 96, 48, 48, 28, 0, 
	/* '|'  */ 24, 24, 24, 24, 24, 24, 24, 0, 
	/* '}'  */ 56, 12, 12, 6, 12, 12, 56, 0, 
	/* '~'  */ 50, 76, 0, 0, 0, 0, 0, 0, 
	/* 0x7F */ 170, 85, 170, 85, 170, 85, 170, 85, 
};

/******************************************************************************/

static unsigned char *pixels;
static size_t pixels_len, rowbytes;
static unsigned xres, yres;
static uint16_t pal16[16] = {
	RGB565(0,0,0), RGB565(0,0,170), RGB565(0,170,0), RGB565(0,170,170),
	RGB565(170,0,0), RGB565(170,0,170), RGB565(170,85,0), RGB565(170,170,170),
	RGB565(85,85,85), RGB565(85,85,255), RGB565(85,255,85), RGB565(85,255,255),
	RGB565(255,85,85), RGB565(255,85,255), RGB565(255,255,85), RGB565(255,255,255),
};

/******************************************************************************/


void
glyph16(unsigned short x, unsigned short y, uint8_t ch, uint8_t attr)
{
	/* expand 2 bits into 2 16-bit pixels */
	static const uint32_t tab[4] = {
	       	0x00000000, 0xffff0000, 0x0000ffff, 0xffffffff,
       	};
	const uint8_t *c = font + font_h * ((font_w + 7) / 8) * (ch - font_base);
	unsigned w = font_w, h = font_h;
	uint32_t fgx, bgx, eorx;
	uint32_t *out;
	unsigned row, col;
	size_t adj;

	fgx = pal16[attr & 15];
	bgx = pal16[(attr >> 4) & 15];
	fgx |= (fgx << 16);
	bgx |= (bgx << 16);
	eorx = fgx ^ bgx;

	out = (uint32_t*)((uint8_t*)pixels + y * rowbytes + x * 2);
	adj = rowbytes / 4 - (w / 2); // TODO: calculate this properly
	for (row = 0; row < h; row++) {
		for (col = 0; col < w; col += 8) {
			gfx_write32((tab[*c >> 6] & eorx) ^ bgx, out++);
			gfx_write32((tab[*c >> 4 & 3] & eorx) ^ bgx, out++);
			gfx_write32((tab[*c >> 2 & 3] & eorx) ^ bgx, out++);
			gfx_write32((tab[*c & 3] & eorx) ^ bgx, out++);
			c++;
		}
		out += adj;
	}
}

void
clear(void *pixels, size_t pixels_len)
{
	memset(pixels, 0, pixels_len);
}

void
draw16(void)
{
	unsigned x = 0, y = 0;

	for (y = 0; y <= yres - font_h; y += 8) {
		for (x = 0; x <= xres - font_w; x += 8) {
			unsigned char ch = (rand() % font_glyphs) + font_base;
			unsigned char attr = rand() % 256;
			glyph16(x, y, ch, attr);
		}
	}

	/*
	glyph16(rand() % (xres - font_w), rand() % (yres - font_h), '!', 0x1e);
	glyph16(rand() % (xres - font_w), rand() % (yres - font_h), '$', 0x1e);
	glyph16(rand() % (xres - font_w), rand() % (yres - font_h), '\x7f', 0x1e);
	*/
}

/******************************************************************************/

int
main()
{
	srand(time(0));

	if (gfx_open(&xres, &yres, &rowbytes))
		return 1;

	if (gfx_setbpp(16, &rowbytes))
		return 1;

	pixels = gfx_buffer(&pixels_len);
	if (!pixels)
		return 1;

	clear(pixels, pixels_len);

	draw16();

	gfx_close();

	return 0;
}
